// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum PostStatus {
  PUBLISHED
  PENDING
  HIDDEN
  REPORTED
}

model User {
  id                     String               @id @default(cuid())
  email                  String               @unique
  passwordHash           String
  name                   String
  username               String?              @unique
  slug                   String?              @unique
  role                   String               @default("USER")
  avatarUrl              String?
  city                   String?
  bannerUrl              String?
  district               String?
  phone                  String?
  phoneVerifiedAt        DateTime?
  emailVerifiedAt        DateTime?
  deletedAt              DateTime?
  bio                    String?
  about                  String?
  website                String?
  location               String?
  lastSeenAt             DateTime?
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt
  ChatMessage            ChatMessage[]
  Club                   Club?                @relation("ClubModerator")
  comments               Comment[]            @relation("UserComments")
  following              Follow[]             @relation("UserFollowing")
  followers              Follow[]             @relation("UserFollowers")
  likes                  Like[]               @relation("UserLikes")
  Memberships            Membership[]
  Notifications          Notification[]
  PaymentIntent          PaymentIntent[]
  posts                  Post[]               @relation("UserPosts")
  Subscriptions          Subscription[]
  dmMessagesAuthored     DmMessage[]          @relation("DmMessageAuthor")
  dmThreadsAsA           DmThread[]           @relation("DmThreadUserA")
  dmThreadsAsB           DmThread[]           @relation("DmThreadUserB")
  dmThreadsRequested     DmThread[]           @relation("DmThreadRequestAuthor")
  PasswordResetTokens    PasswordResetToken[]
  EmailVerificationToken EmailVerificationToken[]
  NotificationPreference NotificationPreference?
  PhoneVerification      PhoneVerification[]
  DmThreadReads          DmThreadRead[]
  DmReactions            DmReaction[]
  PostReports            PostReport[]         @relation("UserReports")
  MeetingPresence        MeetingPresence[]
  EventMailsAuthored     EventMail[]          @relation("EventMailAuthor")
  EventMailRecipients    EventMailRecipient[] @relation("EventMailRecipientUser")
}

model Notification {
  id        String    @id @default(cuid())
  userId    String
  type      String
  payload   String
  readAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Club {
  id             String          @id @default(cuid())
  slug           String          @unique
  name           String
  description    String?
  country        String          @default("Türkiye")
  city           String?
  bannerUrl      String?
  priceTRY       Int             @default(49)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  published      Boolean         @default(false)
  moderatorId    String          @unique
  chatRooms      ChatRoom[]
  moderator      User            @relation("ClubModerator", fields: [moderatorId], references: [id])
  events         ClubEvent[]
  memberships    Membership[]
  paymentIntents PaymentIntent[]
  subscriptions  Subscription[]

  capacity       Int?
}

model Membership {
  id       String   @id @default(cuid())
  userId   String
  clubId   String
  clubEventId String
  role     String   @default("MEMBER")
  isActive Boolean  @default(true)
  joinedAt DateTime @default(now())
  club     Club     @relation(fields: [clubId], references: [id])
  event    ClubEvent @relation(fields: [clubEventId], references: [id])
  user     User     @relation(fields: [userId], references: [id])

  @@unique([userId, clubEventId])
}

model Subscription {
  id         String    @id @default(cuid())
  userId     String
  clubId     String
  clubEventId String
  active     Boolean   @default(false)
  startedAt  DateTime?
  canceledAt DateTime?
  club       Club      @relation(fields: [clubId], references: [id])
  event      ClubEvent @relation(fields: [clubEventId], references: [id])
  user       User      @relation(fields: [userId], references: [id])

  @@unique([userId, clubEventId])
}

model PaymentIntent {
  id          String   @id @default(cuid())
  userId      String
  clubId      String
  clubEventId String
  amountTRY   Int
  status      String   @default("REQUIRES_PAYMENT")
  createdAt   DateTime @default(now())
  merchantOid String   @unique
  club        Club     @relation(fields: [clubId], references: [id])
  event       ClubEvent @relation(fields: [clubEventId], references: [id])
  user        User     @relation(fields: [userId], references: [id])

  @@index([createdAt])
}

model ClubEvent {
  id       String   @id @default(cuid())
  clubId   String
  startsAt DateTime
  title    String   @default("Aylık Oturum")
  notes    String?
  priceTRY Int?
  capacity Int?
  bookTitle String?
  bookAuthor String?
  bookTranslator String?
  bookPages Int?
  bookIsbn String?
  bookCoverUrl String?
  club     Club     @relation(fields: [clubId], references: [id])
  memberships Membership[]
  subscriptions Subscription[]
  paymentIntents PaymentIntent[]
  chatRoom ChatRoom?
  meeting       Meeting?
  meetingPresences MeetingPresence[]
  reminders     EventReminder[]
  mails         EventMail[]
}

model Meeting {
  id          String   @id @default(cuid())
  clubEventId String   @unique
  isActive    Boolean  @default(false)
  opensAt     DateTime?
  startedAt   DateTime?
  endedAt     DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  event       ClubEvent @relation(fields: [clubEventId], references: [id])
}

model MeetingPresence {
  id          String   @id @default(cuid())
  clubEventId String
  userId      String
  joinedAt    DateTime @default(now())
  lastSeenAt  DateTime @default(now())
  leftAt      DateTime?
  allowSpeak  Boolean  @default(false)
  micOn       Boolean  @default(false)
  cameraOn    Boolean  @default(false)
  event       ClubEvent @relation(fields: [clubEventId], references: [id])
  user        User      @relation(fields: [userId], references: [id])

  @@unique([clubEventId, userId])
  @@index([clubEventId])
}

model EventReminder {
  id          String   @id @default(cuid())
  clubEventId String
  kind        String
  sentAt      DateTime @default(now())
  event       ClubEvent @relation(fields: [clubEventId], references: [id])

  @@unique([clubEventId, kind])
  @@index([clubEventId])
}

model EventMail {
  id          String    @id @default(cuid())
  eventId     String
  subject     String
  previewText String?
  bodyHtml    String
  note        String?
  sendScope   String    @default("ALL")
  createdAt   DateTime  @default(now())
  createdById String?
  event       ClubEvent @relation(fields: [eventId], references: [id])
  createdBy   User?     @relation("EventMailAuthor", fields: [createdById], references: [id])
  recipients  EventMailRecipient[]
}

model EventMailRecipient {
  id        String   @id @default(cuid())
  mailId    String
  userId    String?
  email     String
  name      String?
  status    String   @default("PENDING")
  sentAt    DateTime?
  error     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  mail      EventMail @relation(fields: [mailId], references: [id], onDelete: Cascade)
  user      User?      @relation("EventMailRecipientUser", fields: [userId], references: [id])

  @@index([mailId])
  @@index([userId])
}

model NotificationPreference {
  id                         String   @id @default(cuid())
  userId                     String   @unique
  user                       User     @relation(fields: [userId], references: [id])
  emailFollow                Boolean  @default(true)
  emailPostLike              Boolean  @default(true)
  emailPostComment           Boolean  @default(true)
  emailClubModeratorPost     Boolean  @default(true)
  emailClubModeratorSecret   Boolean  @default(true)
  emailClubNewMessagesDaily  Boolean  @default(true)
  emailClubCreated           Boolean  @default(true)
  emailClubNewEvent          Boolean  @default(true)
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt
}

model EmailVerificationToken {
  id         String   @id @default(cuid())
  userId     String
  email      String
  token      String   @unique
  createdAt  DateTime @default(now())
  expiresAt  DateTime
  consumedAt DateTime?
  user       User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model PhoneVerification {
  id         String   @id @default(cuid())
  userId     String
  phone      String
  code       String
  createdAt  DateTime @default(now())
  expiresAt  DateTime
  verifiedAt DateTime?
  attempts   Int      @default(0)
  user       User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model ChatRoom {
  id          String        @id @default(cuid())
  clubId      String?       @unique
  clubEventId String        @unique
  messages    ChatMessage[]
  club        Club?         @relation(fields: [clubId], references: [id])
  event       ClubEvent     @relation(fields: [clubEventId], references: [id])
}

model ChatMessage {
  id        String        @id @default(cuid())
  roomId    String
  authorId  String
  body      String
  isSecret  Boolean       @default(false)
  quotedId  String?
  createdAt DateTime      @default(now())
  author    User          @relation(fields: [authorId], references: [id])
  quoted    ChatMessage?  @relation("Quote", fields: [quotedId], references: [id])
  quotedBy  ChatMessage[] @relation("Quote")
  room      ChatRoom      @relation(fields: [roomId], references: [id])
}

model Post {
  id          String      @id @default(cuid())
  ownerId     String
  body        String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  clientToken String?     @unique
  images      PostImage[]
  comments    Comment[]
  likes       Like[]
  owner       User        @relation("UserPosts", fields: [ownerId], references: [id])
  status      PostStatus  @default(PENDING)
  reports     PostReport[]
  // Rebookie (repost/quote) desteği
  repostOfId  String?
  repostOf    Post?       @relation("Repost", fields: [repostOfId], references: [id])
  reposts     Post[]      @relation("Repost")

  @@index([ownerId, createdAt])
  @@index([status, createdAt])
  @@index([repostOfId])
}

model PostImage {
  id     String @id @default(cuid())
  postId String
  url    String
  width  Int?
  height Int?
  post   Post   @relation(fields: [postId], references: [id])

  @@index([postId])
}

model Like {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())
  post      Post     @relation(fields: [postId], references: [id])
  user      User     @relation("UserLikes", fields: [userId], references: [id])

  @@unique([postId, userId])
  @@index([userId])
}

model Comment {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  body      String
  createdAt DateTime @default(now())
  post      Post     @relation(fields: [postId], references: [id])
  user      User     @relation("UserComments", fields: [userId], references: [id])

  @@index([postId])
  @@index([userId])
}

model Follow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())

  follower    User     @relation("UserFollowing", fields: [followerId], references: [id])
  following   User     @relation("UserFollowers", fields: [followingId], references: [id])

  @@unique([followerId, followingId])
  @@index([followingId])
  @@index([followerId])
}

model DmThread {
  id             String          @id @default(cuid())
  userAId        String
  userBId        String
  lastMessage    DateTime        @default(now())
  status         DmThreadStatus  @default(ACTIVE)
  requestedById  String?
  requestedAt    DateTime?
  lastDecisionAt DateTime?
  userA          User            @relation("DmThreadUserA", fields: [userAId], references: [id])
  userB          User            @relation("DmThreadUserB", fields: [userBId], references: [id])
  requestedBy    User?           @relation("DmThreadRequestAuthor", fields: [requestedById], references: [id])
  messages       DmMessage[]
  reads          DmThreadRead[]

  @@unique([userAId, userBId])
  @@index([lastMessage])
  @@index([status])
  @@index([requestedById])
}

model DmMessage {
  id        String   @id @default(cuid())
  threadId  String
  authorId  String
  body      String
  createdAt DateTime @default(now())
  thread    DmThread @relation(fields: [threadId], references: [id])
  author    User     @relation("DmMessageAuthor", fields: [authorId], references: [id])
  reactions DmReaction[]

  @@index([threadId, createdAt])
}

model DmThreadRead {
  id         String   @id @default(cuid())
  threadId   String
  userId     String
  lastReadAt DateTime @default(now())
  thread     DmThread @relation(fields: [threadId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@unique([threadId, userId])
  @@index([userId])
  @@index([threadId, lastReadAt])
}

model PasswordResetToken {
  id        String    @id @default(cuid())
  userId    String
  tokenHash String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  user      User      @relation(fields: [userId], references: [id])

  @@index([userId, expiresAt])
}

model PostReport {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  reason    String
  createdAt DateTime @default(now())

  post      Post     @relation(fields: [postId], references: [id])
  user      User     @relation("UserReports", fields: [userId], references: [id])

  @@index([postId, createdAt])
  @@index([userId, createdAt])
}

enum DmThreadStatus {
  ACTIVE
  REQUESTED
  ARCHIVED
}

model DmReaction {
  id        String   @id @default(cuid())
  messageId String
  userId    String
  emoji     String
  createdAt DateTime @default(now())
  message   DmMessage @relation(fields: [messageId], references: [id])
  user      User      @relation(fields: [userId], references: [id])

  @@unique([messageId, userId, emoji], name: "messageId_userId_emoji")
  @@index([messageId])
}

// Simple banner/ad model
model Ad {
  id        String   @id @default(cuid())
  title     String
  type      String   @default("image_full") // image_full | announcement
  slot      String   @default("feed")       // feed | hero | sidebar
  imageUrl  String?
  mobileImageUrl String?
  desktopImageUrl String?
  linkUrl   String?
  html      String?
  mobileHtml String?
  desktopHtml String?
  device    String   @default("all") // all | mobile | desktop
  active    Boolean  @default(true)
  startsAt  DateTime?
  endsAt    DateTime?
  weight    Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  campaignId String?
  campaign   AdCampaign? @relation(fields: [campaignId], references: [id])
}

model AdCampaign {
  id        String  @id @default(cuid())
  name      String
  type      String  @default("rotate") // rotate | pinned_top
  frequency Int     @default(1)
  scope     String  @default("all")
  active    Boolean @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Ads       Ad[]
}
